Description: "Create a CodePipeline for deploying static files - (v1.0.0)"
Resources:
  # Create a simple S3 bucket that the CodePipeline will use for storing artifacts between stages.
  CodePipelineBucket:
    Type: "AWS::S3::Bucket"
    DeletionPolicy: "Delete"
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: "AES256"
      LifecycleConfiguration:
        Rules:
        # TODO: Look into having this bucket clear out completely every so often.
        - Id: "DefaultObjectMaxAge"
          Prefix: ""
          Status: "Enabled"
          AbortIncompleteMultipartUpload:
            DaysAfterInitiation: "27"
          ExpirationInDays: "27"
          NoncurrentVersionExpirationInDays: "27"
      PublicAccessBlockConfiguration:
        # Block public access to buckets and objects granted through new access control lists (ACLs)
        BlockPublicAcls: true
        # Block public access to buckets and objects granted through any access control lists (ACLs)
        IgnorePublicAcls: true
        # Block public access to buckets and objects granted through new public bucket or access point policies
        BlockPublicPolicy: true
        # Block public and cross-account access to buckets and objects through any public bucket or access point policies
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: "Suspended"
      Tags:
      - Key: "StackName"
        Value: !Ref "AWS::StackName"

  # Create a role that the CodePipeline can use for deploying resources.
  CodePipelineRole:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Principal:
            Service:
            - "codepipeline.amazonaws.com"
          Action:
          - "sts:AssumeRole"
      Policies:
      - PolicyName: "SetupServiceRole"
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: "Allow"
            Action:
            - "events:*"
            Resource: "*"
          # These IAM actions are needed for CodePipeline to successfully pass IAM roles to stage actions, etc.
          - Effect: "Allow"
            Action:
            - "iam:AttachRolePolicy"
            - "iam:CreateRole"
            - "iam:CreateServiceLinkedRole"
            - "iam:DeleteRole"
            - "iam:DeleteRolePermissionsBoundary"
            - "iam:DeleteRolePolicy"
            - "iam:DeleteServiceLinkedRole"
            - "iam:DetachRolePolicy"
            - "iam:GetRole"
            - "iam:GetRolePolicy"
            - "iam:GetServiceLinkedRoleDeletionStatus"
            - "iam:ListAttachedRolePolicies"
            - "iam:ListInstanceProfilesForRole"
            - "iam:ListRolePolicies"
            - "iam:ListRoleTags"
            - "iam:PassRole"
            - "iam:PutRolePermissionsBoundary"
            - "iam:PutRolePolicy"
            - "iam:TagRole"
            - "iam:UntagRole"
            - "iam:UpdateAssumeRolePolicy"
            - "iam:UpdateRole"
            - "iam:UpdateRoleDescription"
            Resource: "*"
      ManagedPolicyArns:
      - "arn:aws:iam::aws:policy/AmazonS3FullAccess"
      Tags:
      - Key: "StackName"
        Value: !Ref "AWS::StackName"

  CodePipeline:
    Type: "AWS::CodePipeline::Pipeline"
    Properties:
      RoleArn: !GetAtt CodePipelineRole.Arn
      Name: "Static"
      RestartExecutionOnUpdate: true
      ArtifactStores:
      - Region: !Ref "AWS::Region"
        ArtifactStore:
          Type: "S3"
          Location: !Ref CodePipelineBucket
      Stages:
      # https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-CodestarConnectionSource.html
      - Name: "Source"
        Actions:
        - Name: "Jamstack_Website_Source"
          Namespace: "JamstackWebsite"
          ActionTypeId:
            Category: "Source"
            Owner: "AWS"
            Provider: "CodeStarSourceConnection"
            Version: "1"
          Configuration:
            ConnectionArn: "arn:aws:codestar-connections:region:account-id:connection/connection-id" #Need to set this.
            FullRepositoryId: "ngamradt/cfn-git-sync-boilerplate" #Need to set this.
            BranchName: "main"
            OutputArtifactFormat: "CODE_ZIP"
          OutputArtifacts:
          - Name: "WEBSITE_SOURCE_FILES"
          RunOrder: 1
      - Name: "Deployment"
        Actions:
        - Name: "Files_to_S3"
          ActionTypeId:
            Category: "Deploy"
            Owner: "AWS"
            Provider: "S3"
            Version: "1"
          Configuration: # Update this entire configuration session.
            BucketName: !Sub "${InfrastructureName}-${ProductName}-site-${AWS::Region}"
            CacheControl: !If [ BuildFileCacheControl, !Ref BuildFileCacheControl, !Ref "AWS::NoValue" ]
            Extract: true
            ObjectKey: !If [ DynamicContentBasePath, !Ref DynamicContentBasePath, !Ref "AWS::NoValue" ]
          InputArtifacts:
          - Name: "WEBSITE_SOURCE_FILES"
          RunOrder: 2
          Region: !Ref "AWS::Region"